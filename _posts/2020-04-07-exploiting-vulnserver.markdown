---
layout: post
title:  "Exploiting Vulnserver!"
date:   2020-04-07 13:30:00 -0500
categories: [cybersec, hacking, programming]
---

## The course

As part of on-the-job training, I got the chance to take a really nice course on UDemy called 'Ethical Hacking & Bug 
Hunting: Buffer Overflow For Beginners' by Eslam Medhat.

<https://www.udemy.com/course/buffer-overflow-course-exploit-development/>

It uses Kali and Windows VMs that communicate with eachother in order to perform DLL injection that leads to a reverse
shell being opened.

As someone who has never exploited this vulnerability before, this course gave me an intimate look into exactly how
these attacks occur and how to craft one from scratch, provided you have the binary of the exploitable program.

## The tools

- [Kali VM][kali-vm-git]  
    - Metasploit Framework
        - Used for creating payloads like reverse shells
        - pattern_create.rb
            - Used to create a pattern (`Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1` ...) that is 
            unique every 3 bytes to determine where data is injected into a buffer if you are only able to see 3-4 bytes,
            like in CPU registers 
            - This is useful when attempting to determine exactly when a buffer begins to overflow into the stack. 
        - pattern_offset.rb
            - Used to identify a sub-pattern to a position (i.e. `a1A` would be position 3)
    - NetCat / nc
        - Used to poke simple TCP programs like vulnserver to see if they expose vulnerable functionality.
    - spike / tcp_send_packet
        - Used to fuzz inputs to TCP programs, to see what causes a server to crash or do other interesting things...
    - Python 2
        - Used to send our payload, concatenate our buffer overflow buf with the payload, print things nicely, etc...
- [Windows VM][windows-vm-git]
    - vulnserver
        - The star of the show! Some odd TCP server that's very vulnerable.
        - Loads a DLL called essfunc.dll with no memory protections.
    - ImmunityDebugger
        - Used to debug Windows binary programs.
        - Break on specific memory locations being executed.
        - Inspect CPU registers and go to memory locations to see if a payload has been injected or not.
        - [mona][mona-git]
            - An extension for ImmunityDebugger.    
            - Search for loaded DLLs and display their memory protections
            - ??? Much more. We did not use other functionality of mona in the lab.

## Setup

1.  Set up a windows machine Use a VM or segregate the windows machine as this server allows attackers
to gain admin access remotely.

    1.  Download [vulnserver][vulnserver-git].
    
    1.  Download [Immunity Debugger][immunity-git].

2.  Set up Kali Linux or any other linux distro with the tools listed above.

3. Make sure the VMs can communicate. Windows does not respond to pings AFAIK.

## The research

### NetCat

I ran NetCat against the windows vulnserver and was greeted with a prompt. vulnserver is a simple application that uses
TCP TELNET-style communications that are ended with newlines, so netcat was able to easily communicate with it.

![In nc on Kali ](/static/images/2020-04-07-exploiting-vulnserver/nc-to-vulnserver.png)

![In vulnserver on Windows](/static/images/2020-04-07-exploiting-vulnserver/windows-vs.png)

### Spike

I used spike to see what command would cause the server to crash. Spike is a TCP fuzzer.

I only tested TRUN as the guide spared me the tedium of testing all of the other commands.

command.spk:
```c
s_readline();
s_string("TRUN ");
s_string_variable("0");
```

This file contains c code that SPIKE uses to fuzz packets that are sent to the server.

You can perform the fuzzing like this:

    generic_send_tcp 192.168.33.16 701 command.spk 0 0

Before you do this, make sure that:

1.  vulnserver is actually running. Keep in mind that this command will crash it.

2.  You're recording the packets sent to vulnserver with Wireshark or `tcpdump` or another tool.
    Alternatively you can attach Immunity Debugger to vulnserver and inspect the registers when it crashes.
    This is important to craft the payload later.

I used `sudo tcpdump port 9999 -vv` to view the payloads sent by SPIKE.

![](/static/images/2020-04-07-exploiting-vulnserver/tcpdump%209999.png)

After the fuzzing, you should get a \*\*\*\*load of output from the `tcpdump` command. The last TCP sequence will be the
one that crashed vulnserver so that contains the beginning of a payload.

TODO <!-- POTATO-->

## The attack

TODO


[windows-vm-git]:   https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/windows-vulnerable
[kali-vm-git]:      https://github.com/HenryFBP/VagrantPackerFiles/tree/master/vagrant/kali
[mona-git]:         https://github.com/corelan/mona
[vulnserver-git]:   https://github.com/stephenbradshaw/vulnserver
[immunity-git]:     https://github.com/kbandla/ImmunityDebugger